import{_ as e,L as t,n as a,o as l,c as i,w as n,i as r,a as o,d as s,e as d,r as u,F as c,I as p,q as f,f as g,g as m,t as _,h,j as x,k as y,p as b,l as v}from"./index-1840daf0.js";import{_ as k}from"./download-excel.4ab46441.js";import{_ as C}from"./uni-dateformat.458f1f6d.js";import{_ as w}from"./uni-data-picker.21c9b4ff.js";import{_ as I}from"./uni-pagination.904e9ef3.js";import{_ as D}from"./unicloud-db.34f81f65.js";import"./uni-load-more.bb58fed9.js";const j={audience_type_valuetotext:{ALL:"所有用户",user_id:"用户ID",user_tag:"用户标签",device_id:"设备id",push_clientid:"个推客户端id",getui_custom_tag:"个推自定义客户端标签"},platform_valuetotext:[{text:"小程序和H5",value:"web"},{text:"iOS",value:"ios"},{text:"Android",value:"android"}]};const $=t.database(),L=[],S={ascending:"asc",descending:"desc"};function q(e,t){const a=Object.keys(e);if(a.length!=Object.keys(t).length)return!1;for(let l=0;l<a.length;l++){let i=a[l],n=e[i];if(n!=t[i]){if("object"!=typeof n||"object"!=typeof t[i])return!1;if(!q(n,t[i]))return!1}}return!0}const z=e({data:()=>({collectionList:"uni-push-log,uni-id-users",query:"",where:"",orderby:"creat_time desc",orderByFieldName:"",selectedIndexs:[],options:{pageSize:20,pageCurrent:1,filterData:{audience_type_localdata:[{text:"所有用户",value:"ALL"},{text:"用户id",value:"user_id"},{text:"用户标签",value:"user_tag"},{text:"设备id",value:"device_id"},{text:"个推客户端id",value:"push_clientid"},{text:"个推自定义客户端标签",value:"getui_custom_tag"}],platform_localdata:[{text:"全部",value:"ALL"},{text:"网页端",value:"web"},{text:"App-iOS",value:"app-ios"},{text:"App-Android",value:"app-android"},{text:"微信小程序",value:"mp-weixin"},{text:"360小程序",value:"mp-360"},{text:"百度小程序",value:"mp-baidu"},{text:"支付宝小程序",value:"mp-alipay"},{text:"字节跳动小程序",value:"mp-toutiao"},{text:"QQ小程序",value:"mp-qq"},{text:"快应用联盟",value:"quickapp-webview-union"},{text:"快应用华为",value:"quickapp-webview-huawei"},{text:"快手小程序",value:"mp-kuaishou"},{text:"飞书小程序",value:"mp-lark"},{text:"京东小程序",value:"mp-jd"}]},...j},imageStyles:{width:64,height:64},exportExcel:{filename:"uni-push-log.xls",type:"xls",fields:{"通知标题":"title","推送时间":"creat_time","目标用户":"audience_type","目标用户标识":"audience_value","目标平台":"platform","推送状态":"state","消息内容":"payload","应用的id":"appId","任务id":"taskid","消息可下发数":"msg_num","消息下发数":"target_num","消息接收数":"receive_num","消息展示数":"display_num","消息点击数":"click_num"}},exportExcelData:[]}),onLoad(){this._filter={}},onReady(){this.$refs.udb.loadData()},methods:{async onqueryload(e){const a=t.importObject("uni-push-co");let l={};e.forEach((e=>{l[e.appId]?l[e.appId].push(e):l[e.appId]=[e]}));for(let t in l){let i=l[t].map((e=>e.taskid)),n=await a.getReport({appId:t,taskid:i});n.data?e.forEach((e=>{n.data[e.taskid]&&(e.report&&q(e.report,n.data[e.taskid])||(e.report=n.data[e.taskid],$.collection("uni-push-log").doc(e._id).update({report:e.report}).then((e=>{}))))})):console.log("查不到相关记录")}this.$set(e,e),this.exportExcelData=e},getWhere(){const e=this.query.trim();if(!e)return"";const t=new RegExp(e,"i");return L.map((e=>t+".test("+e+")")).join(" || ")},search(){const e=this.getWhere();this.where=e,this.$nextTick((()=>{this.loadData()}))},loadData(e=!0){this.$refs.udb.loadData({clear:e})},onPageChanged(e){this.selectedIndexs.length=0,this.$refs.table.clearSelection(),this.$refs.udb.loadData({current:e.current})},navigateTo(e,t){a({url:e,events:{refreshData:()=>{this.loadData(t)}}})},selectedItems(){var e=this.$refs.udb.dataList;return this.selectedIndexs.map((t=>e[t]._id))},delTable(){this.$refs.udb.remove(this.selectedItems(),{success:e=>{this.$refs.table.clearSelection()}})},selectionChange(e){this.selectedIndexs=e.detail.index},confirmDelete(e){this.$refs.udb.remove(e,{success:e=>{this.$refs.table.clearSelection()}})},sortChange(e,t){this.orderByFieldName=t,e.order?this.orderby=t+" "+S[e.order]:this.orderby="",this.$refs.table.clearSelection(),this.$nextTick((()=>{this.$refs.udb.loadData()}))},filterChange(e,t){this._filter[t]={type:e.filterType,value:e.filter};let a=function(e,t){let a={};for(let l in e){let{type:i,value:n}=e[l];switch(i){case"search":"string"==typeof n&&n.length&&(a[l]=new RegExp(n));break;case"select":if(n.length){let e=[];for(let a of n)e.push(t.eq(a));a[l]=t.or(e)}break;case"range":if(n.length){let e=n[0],i=n[1];a[l]=t.and([t.gte(e),t.lte(i)])}break;case"date":if(n.length){let[e,i]=n,r=new Date(e),o=new Date(i);a[l]=t.and([t.gte(r),t.lte(o)])}break;case"timestamp":if(n.length){let[e,i]=n;a[l]=t.and([t.gte(e),t.lte(i)])}}}return a}(this._filter,$.command);Object.keys(a).length?this.where=a:this.where="",this.$nextTick((()=>{this.$refs.udb.loadData()}))}}},[["render",function(e,t,a,j,$,L){const S=r,q=p,z=f,E=g(m("download-excel"),k),T=g(m("uni-th"),h),A=g(m("uni-tr"),x),F=g(m("uni-td"),y),O=g(m("uni-dateformat"),C),V=b,R=g(m("uni-data-picker"),w),U=g(m("uni-table"),v),N=g(m("uni-pagination"),I),B=g(m("unicloud-db"),D);return l(),i(S,null,{default:n((()=>[o(S,{class:"uni-header"},{default:n((()=>[o(S,{class:"uni-group"},{default:n((()=>[o(S,{class:"uni-title"}),o(S,{class:"uni-sub-title"})])),_:1}),o(S,{class:"uni-group"},{default:n((()=>[o(q,{class:"uni-search",type:"text",modelValue:$.query,"onUpdate:modelValue":t[0]||(t[0]=e=>$.query=e),onConfirm:L.search,placeholder:"请输入搜索内容"},null,8,["modelValue","onConfirm"]),o(z,{class:"uni-button",type:"default",size:"mini",onClick:L.search},{default:n((()=>[s("搜索")])),_:1},8,["onClick"]),o(z,{class:"uni-button",type:"default",size:"mini",disabled:!$.selectedIndexs.length,onClick:L.delTable},{default:n((()=>[s("批量删除")])),_:1},8,["disabled","onClick"]),o(E,{class:"hide-on-phone",fields:$.exportExcel.fields,data:$.exportExcelData,type:$.exportExcel.type,name:$.exportExcel.filename},{default:n((()=>[o(z,{class:"uni-button",type:"primary",size:"mini"},{default:n((()=>[s("导出 Excel")])),_:1})])),_:1},8,["fields","data","type","name"])])),_:1})])),_:1}),o(S,{class:"uni-container"},{default:n((()=>[o(B,{ref:"udb",collection:$.collectionList,field:"report,title,creat_time,audience_type,audience_value,platform,state,payload,appId,taskid,msg_num,target_num,receive_num,display_num,click_num,operator_id{username}",where:$.where,"page-data":"replace",orderby:$.orderby,getcount:!0,"page-size":$.options.pageSize,"page-current":$.options.pageCurrent,options:$.options,loadtime:"manual",onLoad:L.onqueryload},{default:n((({data:e,pagination:a,loading:r,error:p,options:f})=>[o(U,{ref:"table",loading:r,emptyText:p.message||"没有更多数据",border:"",stripe:"",type:"selection",onSelectionChange:L.selectionChange},{default:n((()=>[o(A,null,{default:n((()=>[o(T,{align:"center"},{default:n((()=>[s("操作员")])),_:1}),o(T,{align:"center",sortable:"",onSortChange:t[1]||(t[1]=e=>L.sortChange(e,"title"))},{default:n((()=>[s("通知栏标题")])),_:1}),o(T,{align:"center","filter-type":"timestamp",onFilterChange:t[2]||(t[2]=e=>L.filterChange(e,"creat_time")),sortable:"",onSortChange:t[3]||(t[3]=e=>L.sortChange(e,"creat_time"))},{default:n((()=>[s("推送时间")])),_:1}),o(T,{align:"center","filter-type":"select","filter-data":f.filterData.audience_type_localdata,onFilterChange:t[4]||(t[4]=e=>L.filterChange(e,"audience_type"))},{default:n((()=>[s("发送目标")])),_:2},1032,["filter-data"]),o(T,{align:"center","filter-type":"select","filter-data":f.filterData.platform_localdata,onFilterChange:t[5]||(t[5]=e=>L.filterChange(e,"platform"))},{default:n((()=>[s("目标平台")])),_:2},1032,["filter-data"]),o(T,{align:"center","filter-type":"search",onFilterChange:t[6]||(t[6]=e=>L.filterChange(e,"appId")),onSortChange:t[7]||(t[7]=e=>L.sortChange(e,"appId"))},{default:n((()=>[s("应用的id")])),_:1}),o(T,{align:"center"},{default:n((()=>[s("目标设备数")])),_:1}),o(T,{align:"center"},{default:n((()=>[s("成功下发数")])),_:1}),o(T,{align:"center"},{default:n((()=>[s("成功接收数（比例）")])),_:1}),o(T,{align:"center"},{default:n((()=>[s("消息展示数（比例）")])),_:1}),o(T,{align:"center"},{default:n((()=>[s("消息点击数（比例）")])),_:1}),o(T,{align:"center"},{default:n((()=>[s("操作")])),_:1})])),_:2},1024),(l(!0),d(c,null,u(e,((e,t)=>(l(),i(A,{key:t},{default:n((()=>[o(F,{align:"center"},{default:n((()=>[s(_(e.operator_id[0]?e.operator_id[0].username:"-"),1)])),_:2},1024),o(F,{align:"center"},{default:n((()=>[s(_(e.title),1)])),_:2},1024),o(F,{align:"center"},{default:n((()=>[o(O,{threshold:[0,0],date:e.creat_time},null,8,["date"])])),_:2},1024),o(F,{align:"center"},{default:n((()=>[s("根据"+_(f.audience_type_valuetotext[e.audience_type]),1)])),_:2},1024),o(F,{align:"center"},{default:n((()=>["ALL"==e.platform?(l(),i(V,{key:0},{default:n((()=>[s("所有平台")])),_:1})):(l(),i(R,{key:1,localdata:f.platform_valuetotext,value:e.platform,border:!1,readonly:!0,split:","},null,8,["localdata","value"]))])),_:2},1024),o(F,{align:"center"},{default:n((()=>[s(_(e.appId),1)])),_:2},1024),o(F,{align:"center"},{default:n((()=>[s(_(e.report?e.report.total.msg_num:"-"),1)])),_:2},1024),o(F,{align:"center"},{default:n((()=>[s(_(e.report?e.report.total.target_num+"，（"+parseInt(e.report.total.target_num/e.report.total.msg_num*100)+"%）":"-"),1)])),_:2},1024),o(F,{align:"center"},{default:n((()=>[s(_(e.report?e.report.total.receive_num+"，（"+parseInt(e.report.total.receive_num/e.report.total.msg_num*100)+"%）":"-"),1)])),_:2},1024),o(F,{align:"center"},{default:n((()=>[s(_(e.report?e.report.total.display_num+"，（"+parseInt(e.report.total.display_num/e.report.total.msg_num*100)+"%）":"-"),1)])),_:2},1024),o(F,{align:"center"},{default:n((()=>[s(_(e.report?e.report.total.click_num+"，（"+parseInt(e.report.total.click_num/e.report.total.msg_num*100)+"%）":"-"),1)])),_:2},1024),o(F,{align:"center"},{default:n((()=>[o(S,{class:"uni-group"},{default:n((()=>[o(z,{onClick:t=>L.navigateTo("./detail?data="+encodeURIComponent(JSON.stringify(e)),!1),class:"uni-button",size:"mini",type:"primary"},{default:n((()=>[s("详情")])),_:2},1032,["onClick"]),o(z,{onClick:t=>L.confirmDelete(e._id),class:"uni-button",size:"mini",type:"warn"},{default:n((()=>[s("删除")])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1024)])),_:2},1024)))),128))])),_:2},1032,["loading","emptyText","onSelectionChange"]),o(S,{class:"uni-pagination-box"},{default:n((()=>[o(N,{"show-icon":"","page-size":a.size,modelValue:a.current,"onUpdate:modelValue":e=>a.current=e,total:a.count,onChange:L.onPageChanged},null,8,["page-size","modelValue","onUpdate:modelValue","total","onChange"])])),_:2},1024)])),_:1},8,["collection","where","orderby","page-size","page-current","options","onLoad"])])),_:1})])),_:1})}]]);export{z as default};
